<view class="map-container">
  <!-- åªæœ‰å½“ä½ç½®æ•°æ®å­˜åœ¨æ—¶æ‰æ¸²æŸ“åœ°å›¾ç»„ä»¶ -->
  <block wx:if="{{latitude && longitude}}">
    <map 
      id="map"
      longitude="{{longitude}}"
      latitude="{{latitude}}"
      scale="{{scale}}"
      markers="{{markers}}"
      polyline="{{polyline}}"
      show-location="true"
      enable-rotate="{{mapSetting.enableRotate}}"
      enable-overlooking="{{mapSetting.enableOverlooking}}"
      enable-zoom="{{mapSetting.enableZoom}}"
      show-compass="{{mapSetting.showCompass}}"
      enable-3D="{{mapSetting.enable3D}}"
      show-scale="{{mapSetting.showScale}}"
      setting="{{mapSetting}}"
      bindmarkertap="onMarkerTap"
      bindupdated="onMapUpdated"
      binderror="onMapError"
    ></map>
    
    <view class="amap-logo">
      <image src="../../images/amap-logo.svg" mode="aspectFit"></image>
    </view>
  </block>
  
  <!-- å½“ä½ç½®æ•°æ®ä¸å­˜åœ¨æ—¶æ˜¾ç¤ºä½ç½®è·å–å¼•å¯¼ -->
  <view class="loading-guide" wx:if="{{!latitude || !longitude}}">
    <view class="guide-content">
      <text class="guide-title">éœ€è¦è·å–ä½ç½®ä¿¡æ¯</text>
      <text class="guide-desc">è¯·å…è®¸è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯ï¼Œä»¥ä¾¿æŸ¥æ‰¾é™„è¿‘çš„å®è—</text>
      <button class="guide-btn" bindtap="getUserLocation">è·å–ä½ç½®</button>
    </view>
  </view>
  
  <!-- ç‚¹å‡»æ ‡é¢˜æ¿€æ´»è°ƒè¯•æ¨¡å¼ -->
  <view class="coordinate-info" wx:if="{{latitude && longitude}}" bindtap="handleTitleClick">
    <text>å½“å‰ä½ç½®: {{latitude && latitude.toFixed(5)}}, {{longitude && longitude.toFixed(5)}} (GCJ-02)</text>
    <text class="map-source">é«˜å¾·åœ°å›¾æœåŠ¡</text>
  </view>
  
  <!-- è°ƒè¯•ä¿¡æ¯ -->
  <view class="debug-info" wx:if="{{isDebugMode}}">
    <view class="debug-section">
      <text class="debug-title">è°ƒè¯•æ¨¡å¼</text>
      <text class="debug-value">å·²æ¿€æ´»</text>
    </view>
    <view class="debug-section" wx:if="{{selectedTreasure}}">
      <text class="debug-title">å®è—åæ ‡: </text>
      <text class="debug-value">{{selectedTreasure.latitude}}, {{selectedTreasure.longitude}}</text>
    </view>
    <view class="debug-section">
      <text class="debug-title">è·ç¦»è®¡ç®—: </text>
      <text class="debug-value">{{distance}}ç±³</text>
    </view>
  </view>
  
  <view class="loading-mask" wx:if="{{loadingTreasures && latitude && longitude}}">
    <view class="loading">
      <text>å®è—åŠ è½½ä¸­</text>
    </view>
  </view>
  
  <view class="loading-mask" wx:if="{{loadingLocation && !loadingTreasures}}">
    <view class="loading">
      <text>ä½ç½®è·å–ä¸­</text>
    </view>
  </view>
  
  <!-- ä½ç½®æ§åˆ¶æŒ‰é’®ç»„ -->
  <view class="map-controls" wx:if="{{latitude && longitude}}">
    <!-- åˆ·æ–°åœ°å›¾æŒ‰é’® -->
    <view class="control-btn refresh-map" bindtap="handleRefresh">
      <text class="control-icon">ğŸ”„</text>
    </view>
    
    <!-- åˆ·æ–°ä½ç½®æŒ‰é’® -->
    <view class="control-btn refresh-location" bindtap="getUserLocation">
      <text class="control-icon">ğŸ“</text>
    </view>
    
    <!-- å®šä½åˆ°æˆ‘çš„ä½ç½®æŒ‰é’® -->
    <view class="control-btn locate-me" bindtap="moveToUserLocation">
      <text class="control-icon">ğŸ¯</text>
    </view>
  </view>
  
  <view class="treasure-card" wx:if="{{selectedTreasure}}">
    <view class="card-header">
      <text class="treasure-name">{{selectedTreasure.name}}</text>
      <text class="treasure-status {{canCollect ? 'status-success' : 'status-warning'}}">
        {{canCollect ? 'å¯ä»¥é¢†å–' : 'æœªåˆ°è¾¾'}}
      </text>
    </view>
    
    <view class="treasure-desc">{{selectedTreasure.description}}</view>
    
    <view class="treasure-distance">
      <text>è·ç¦»: <text class="distance-value">{{distance}}</text> ç±³</text>
      <text class="points-value">å¥–åŠ±ç§¯åˆ†: {{selectedTreasure.points}}</text>
    </view>
    
    <view class="action-buttons">
      <block wx:if="{{!isNavigating}}">
        <button class="nav-btn primary" bindtap="startNavigation">å¼€å§‹å¯¼èˆª</button>
      </block>
      
      <block wx:else>
        <button class="nav-btn warning" bindtap="stopNavigation">ç»“æŸå¯¼èˆª</button>
      </block>
      
      <button 
        class="treasure-btn {{canCollect ? 'active' : 'disabled'}}" 
        bindtap="collectTreasure" 
        disabled="{{!canCollect}}">
        {{canCollect ? 'é¢†å–å®è—' : 'è·ç¦»å¤ªè¿œï¼Œæ— æ³•é¢†å–'}}
      </button>
      
      <!-- æ·»åŠ æ”¶è—æŒ‰é’® -->
      <button 
        class="favorite-btn {{isFavorite ? 'favorited' : ''}}" 
        bindtap="toggleFavorite">
        {{isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}
      </button>
    </view>
  </view>
</view> 