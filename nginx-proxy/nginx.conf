server {
    listen 80;
    server_name imboss.com.cn www.imboss.com.cn;
    
    # HTTP 重定向到 HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name imboss.com.cn www.imboss.com.cn;

    # SSL 证书配置
    ssl_certificate /etc/nginx/ssl/imboss.com.cn_bundle.crt;
    ssl_certificate_key /etc/nginx/ssl/imboss.com.cn.key;
    
    # SSL 安全设置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;
    
    # 转发设置
    location / {
        # 关键修改：使用本地解析，不使用DNS
        resolver 8.8.8.8;
        set $backend "82.156.15.23";
        proxy_pass http://$backend:80;
        
        # 关键：使用域名作为Host头，而不是IP
        proxy_set_header Host imboss.com.cn;
        
        # 强制处理所有可能的重定向情况
        proxy_redirect default off;
        proxy_redirect http://82.156.15.23/ https://imboss.com.cn/;
        proxy_redirect https://82.156.15.23/ https://imboss.com.cn/;
        proxy_redirect http://43.164.134.77/ https://imboss.com.cn/;
        proxy_redirect https://43.164.134.77/ https://imboss.com.cn/;
        
        # 禁用客户端gzip，防止内容被压缩后无法替换URL
        proxy_set_header Accept-Encoding "";
        
        # 标准代理头
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 响应体中替换所有IP为域名（增强版）
        sub_filter "43.164.134.77" "imboss.com.cn";
        sub_filter "82.156.15.23" "imboss.com.cn";
        sub_filter_once off;
        sub_filter_types *;
    }
} 